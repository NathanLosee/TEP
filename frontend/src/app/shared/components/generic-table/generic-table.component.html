<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
  <mat-progress-spinner
    mode="indeterminate"
    diameter="60"
  ></mat-progress-spinner>
</div>

<!-- Empty State -->
<div *ngIf="isEmpty && !isLoading" class="empty-container">
  <mat-icon>{{ emptyIcon }}</mat-icon>
  <h3>{{ emptyTitle }}</h3>
  <p *ngIf="emptyMessage">{{ emptyMessage }}</p>
  <button
    *ngIf="showCreateOnEmpty"
    mat-raised-button
    color="primary"
    [disableIfNoPermission]="creatapermission || ''"
    (click)="createClick.emit()"
  >
    <mat-icon>add</mat-icon>
    {{ createButtonText }}
  </button>
</div>

<!-- Table -->
<table
  *ngIf="!isEmpty && !isLoading"
  mat-table
  [dataSource]="tableDataSource"
  [class]="tableClass"
  matSort
>
  <!-- Dynamic Columns -->
  <ng-container *ngFor="let col of columns" [matColumnDef]="col.key">
    <th
      mat-header-cell
      *matHeaderCellDef
      [mat-sort-header]="enableSort && col.sortable ? col.key : ''"
      [disabled]="!enableSort || !col.sortable"
    >
      {{ col.header }}
    </th>
    <td mat-cell *matCellDef="let row">
      <ng-container [ngSwitch]="col.type">
        <!-- Text -->
        <span *ngSwitchCase="'text'">{{ getValue(row, col) }}</span>

        <!-- Icon with text -->
        <div *ngSwitchCase="'icon-text'" class="table-cell-content">
          <mat-icon>{{ col.icon }}</mat-icon>
          <span>{{ getValue(row, col) }}</span>
        </div>

        <!-- Single Chip -->
        <mat-chip *ngSwitchCase="'chip'" [ngClass]="col.chipClass?.(row)">
          {{ getValue(row, col) }}
        </mat-chip>

        <!-- Chip list preview -->
        <mat-chip-set *ngSwitchCase="'chip-list'" class="chip-list-cell">
          <mat-chip *ngFor="let item of getValue(row, col)?.slice(0, 3)">
            {{ item }}
          </mat-chip>
          <mat-chip
            *ngIf="getValue(row, col)?.length > 3"
            class="more-chip"
            [matTooltip]="getValue(row, col)?.slice(3).join(', ')"
          >
            +{{ getValue(row, col).length - 3 }} more
          </mat-chip>
        </mat-chip-set>

        <!-- Status indicator -->
        <div
          *ngSwitchCase="'status'"
          class="status-indicator"
          [ngClass]="getStatusClass(row, col)"
        >
          <mat-icon>{{ getStatusIcon(row, col) }}</mat-icon>
          <span>{{ getValue(row, col) }}</span>
        </div>

        <!-- Date -->
        <span *ngSwitchCase="'date'">
          {{ getValue(row, col) | date: col.dateFormat || "medium" }}
        </span>

        <!-- Template type - use content projection -->
        <ng-container *ngSwitchCase="'template'">
          <ng-container *ngIf="getTemplate(col.key) as template">
            <ng-container
              *ngTemplateOutlet="
                template;
                context: { $implicit: row, column: col }
              "
            ></ng-container>
          </ng-container>
        </ng-container>

        <!-- Default fallback -->
        <span *ngSwitchDefault>{{ getValue(row, col) }}</span>
      </ng-container>
    </td>
  </ng-container>

  <!-- Actions Column -->
  <ng-container matColumnDef="actions" *ngIf="actions.length > 0">
    <th mat-header-cell *matHeaderCellDef>Actions</th>
    <td mat-cell *matCellDef="let row">
      <div class="table-actions">
        <button
          *ngFor="let action of actions"
          mat-icon-button
          [matTooltip]="action.tooltip"
          [color]="action.color"
          [disabled]="action.disabled?.(row)"
          [disableIfNoPermission]="action.permission || ''"
          [ngClass]="action.class"
          (click)="onActionClick(action.action, row, $event)"
        >
          <mat-icon>{{ action.icon }}</mat-icon>
        </button>
      </div>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumnKeys"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumnKeys"></tr>
</table>
