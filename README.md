# Python Super Health API Project

REST API for Super Health business operations. Allows for the management of information about patients and their encounters with care providers.

## Prerequisites

This application was initialized with python 3.11.5. You can check your version by running `python --version` from the terminal/command prompt. To download the version 3.11.5 of Python, visit <a href="https://www.python.org/downloads/release/python-3115/" target="_blank">https://www.python.org/downloads/release/python-3115/</a>.

Also, you must have Poetry installed. The version of Poetry used to create this application was 1.6.1. You can verify your version by typing `poetry --version` in the terminal/command prompt. To download poetry on your computer, visit <a href="https://python-poetry.org/docs/#installation" target="_blank">https://python-poetry.org/docs/#installation</a>.

This application utilizes a locally-running PostgreSQL database. To download and install PostgreSQL, visit <a href="https://www.postgresql.org/download/" target="_blank">https://www.postgresql.org/download/</a>

**Set up the Project-Level Environment Variables**

1. Create a file in the root directory named `.env`.
2. Open the file and add the following default credentials and configuration:

```text
LOG_LEVEL=INFO
POSTGRES_USER=<your postgres user>
POSTGRES_PASSWORD=<your postgres password>
POSTGRES_DB=super_health
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
```

**Set up the virtual environment and load the packages**

1. Open a terminal/command prompt at the root directory.
2. Enter the following command to create a virtual environment and install the packages: `poetry install`.
3. Follow the instructions given under [Switching to a different virtual environment](#switching-to-a-different-virtual-environment) if you ran into this error message:

```text
The currently activated Python version 3.12.0 is not supported by the project (^3.11.0, <3.12.0).
Trying to find and use a compatible version.

Poetry was unable to find a compatible version. If you have one, you can explicitly use it via the "env use" command.
```

4. Ensure that the virtual environment has been created in `.venv`.
5. Get the path to your virtual environment: `poetry env info --path`.
6. To set up the Python interpreter for your project in VSCode, you need to do the following steps. First, open the command palette by pressing `Ctrl+Shift+P`. Then, type `"Python: Select Interpreter"` and choose the option that shows the path to your project's python.exe file (Windows) or python file (MacOS). It usually has a star icon next to it. Alternatively, you can enter the path manually by choosing the `Enter interpreter path...` option.

**Prepare the database**

Create a database named `super_health` in your locally running PostgreSQL instance.

**Run the Alembic migrations**

1. Open a terminal/command prompt window at the root directory.
2. To update your database to the latest Alembic migration, run the command: `poetry run alembic upgrade head`.
3. You can check the Alembic versions applied to your database by looking at the rows in the `alembic_version` table or by entering the command: `poetry run alembic history`.

#### Switching to a different virtual environment

1. Download and install Python version 3.11.5: https://www.python.org/downloads/release/python-3115/
2. Open a terminal/command prompt window.
3. Run the command: `py -0p`. Copy the path to `-V:3.11` and replace the backlashes with forward-slashes. For example: `C:/Users/mpalacio/AppData/Local/Programs/Python/Python311/python.exe`
4. From the root directory, run the command: `poetry env use /full/path/to/python`. Replacing the path with the one from step 3.
5. Ensure that the virtual environment has been created in `.venv`.
6. Get the path to your virtual environment: `poetry env info --path`.
7. To set up the Python interpreter for your project in VSCode, you need to do the following steps. First, open the command palette by pressing `Ctrl+Shift+P`. Then, type `"Python: Select Interpreter"` and choose the option that shows the path to your project's python.exe file (Windows) or python file (MacOS). It usually has a star icon next to it. Alternatively, you can enter the path manually by choosing the `Enter interpreter path...` option.

## Usage

### Startup

1. Open a terminal/command prompt window at the root directory.
2. Run the command: `poetry run uvicorn src.main:app --reload`
3. The API local development server is available on http://127.0.0.1:8000. You should see a json response by visiting the link:

```json
{
  "message": "Welcome to the Python Super Health API project!"
}
```

4. To view the Swagger docs generated by the API, visit: http://127.0.0.1:8000/docs.

### Shutdown

1. `Ctrl-C` in the terminal window running the uvicorn server.

### Routes

Legend for regular expressions:\
D = Numeric digit\
L = Alphabetic character\
N = Alphabetic Names character (includes hyphens and apostrophe)\
A = Alphanumeric character\
\* = Previous character can repeat

#### ENCOUNTER
_REQUEST SCHEMA_\
patient_id - Type: Integer, must reference an existing patient in the database\
notes - Type: String, optional\
visit_code - Type: String, regex = `ADA DAD`, all letters capitalized\
provider - Type: String\
billing_code - Type: String, regex = `DDD.DDD.DDD-DD`\
icd10 - Type: String, regex = `ADD`, letter capitalized\
total_cost - Type: Float, two-decimal precision, non-negative\
copay - Type: Float, two-decimal precision, non-negative\
chief_complaint - Type: String\
pulse - Type: Integer, optional, non-negative\
systolic - Type: Integer, optional, non-negative\
diastolic - Type: Integer, optional, non-negative\
encounter_date - Type: Date, format = `YYYY-MM-DD`

- **POST** `/patients/<patient_id>/encounters`\
  Creates new encounter for patient with `patient_id`.\
  Requires JSON body following schema.
  - **HTTP 201**: Returns new encounter on success.
  - **HTTP 400**: Field validation fails.
  - **HTTP 400**: `patient_id` in path and `patient_id` in body do not match.
  - **HTTP 404**: Patient with `patient_id` not found.
- **GET** `/patients/<patient_id>/encounters`\
  Gets all encounters for patient with `patient_id`.
  - **HTTP 200**: Returns list of encounters for patient on success.
  - **HTTP 404**: Patient with `patient_id` not found.
- **PUT** `/patients/<patient_id>/encounters/{encounter_id}`\
  Updates encounter with `enounter_id` for patient with `patient_id`.\
  Requires JSON body following schema with additional integer field `id` for encounter being updated.
  - **HTTP 201**: Returns updated encounter on success.
  - **HTTP 400**: Field validation fails.
  - **HTTP 400**: `patient_id` in path and body do not match.
  - **HTTP 400**: `encounter_id` in path and `id` in body do not match.
  - **HTTP 404**: Patient with `patient_id` not found.
  - **HTTP 404**: Encounter with `encounter_id` not found.
  - **HTTP 404**: Encounter with `encounter_id` does not involve patient with `patient_id`.

#### PATIENT
_REQUEST SCHEMA_\
first_name - Type: String, regex = `N*`\
last_name - Type: String, regex = `N*`\
ssn - Type: String, regex = `DDD-DD-DDDD`\
email - Type: String, valid email format\
street - Type: String\
city - Type: String\
state - Type: String, must be valid two-letter US state abbreviation\
postal - Type: String, regex = `DDDDD` or `DDDDD-DDDD`\
age - Type: Integer, non-negative\
height - Type: Integer, non-negative\
weight - Type: Integer, non-negative\
insurance - Type: String\
gender - Type: String, must be one of `male`, `female`, `other`

- **POST** `/patients`\
  Creates new patient.\
  Requires JSON body following schema.
  - **HTTP 201**: Returns new patient on success.
  - **HTTP 400**: Field validation fails.
  - **HTTP 409**: Patient email is already in use.
- **GET** `/patients`\
  Gets all patients.
  - **HTTP 200**: Returns list of patients on success.
- **GET** `/patients/<patient_id>`\
  Gets patient with `patient_id`.
  - **HTTP 200**: Returns patient on success.
  - **HTTP 404**: Patient with `patient_id` not found.
- **PUT** `/patients/<patient_id>`\
  Updates patient with `patient_id`.\
  Requires JSON body following schema with additional integer field `id` for patient being updated.
  - **HTTP 201**: Returns updated patient on success.
  - **HTTP 400**: Field validation fails.
  - **HTTP 400**: `patient_id` in path and `id` in body do not match.
  - **HTTP 404**: Patient with `patient_id` not found.
  - **HTTP 409**: Patient email is already in use by another existing patient.
- **DELETE** `/patients/<patient_id>`\
  Deletes patient with `patient_id`.
  - **HTTP 204**: No returned body on success.
  - **HTTP 404**: Patient with `patient_id` not found.
  - **HTTP 409**: Patient with `patient_id` has encounters and cannot be deleted.

## Testing the project

### Prepare the database

Create a database named `super_health_test` in your locally running PostgreSQL instance.

### Linting the project

Flake8 is used as the linting tool for this project.

1. Open a terminal/command prompt window at the root directory.
2. Run the command: `flake8 src`
3. Recommendations will be printed, if there are any.

### Testing the API with coverage report

1. Open a terminal/command prompt window.
2. From the root directory, run the command: `poetry run pytest tests`
3. This command will run all the API test cases.
4. Use `tests/unit` to run exclusively unit tests.
5. Use `tests/integration` to run exclusively integration tests.
6. Run with options `--cov=src --cov-report=html:cov_html --cov-report=term-missing` to display a coverage report in the terminal. It will also generate a `cov_html` folder with the html version of the coverage report.

### Postman testing

1. In Postman, import [Super Health Collection](SuperHealth Collection.postman_collection.json)
2. Run the transactions in-order.

## License

Copyright (C) 2024 Catalyte. All Rights Reserved.\
Unauthorized copying of this project or resulting data, via any medium, is strictly prohibited.\
Proprietary and confidential.
