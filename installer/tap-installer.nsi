; TAP - Timeclock and Payroll Installer
; NSIS Installer Script
;
; Requirements:
;   - NSIS 3.x installed (https://nsis.sourceforge.io/)
;   - Build output in ../build/TAP-{VERSION}/
;
; Build command:
;   makensis /DVERSION=1.0.0 tap-installer.nsi

;--------------------------------
; Includes

!include "MUI2.nsh"
!include "FileFunc.nsh"
!include "LogicLib.nsh"
!include "nsDialogs.nsh"

;--------------------------------
; General Configuration

!ifndef VERSION
  !define VERSION "1.0.0"
!endif

Name "TAP - Timeclock and Payroll"
OutFile "..\releases\TAP-Setup-${VERSION}.exe"
InstallDir "$PROGRAMFILES64\TAP"
InstallDirRegKey HKLM "Software\MonteVista\TAP" "InstallDir"
RequestExecutionLevel admin
Unicode True

; Version info
VIProductVersion "${VERSION}.0"
VIAddVersionKey "ProductName" "TAP - Timeclock and Payroll"
VIAddVersionKey "CompanyName" "MonteVista Apps"
VIAddVersionKey "FileDescription" "TAP Installer"
VIAddVersionKey "FileVersion" "${VERSION}"
VIAddVersionKey "ProductVersion" "${VERSION}"
VIAddVersionKey "LegalCopyright" "Copyright MonteVista Apps"

;--------------------------------
; Variables

Var RootPassword
Var BackendPort
Var JwtKeyPassword
Var Dialog
Var Label
Var PasswordField
Var PortField

;--------------------------------
; Interface Settings

!define MUI_ABORTWARNING
; Icons - copy favicon.ico to installer folder before building
!define MUI_ICON "favicon.ico"
!define MUI_UNICON "favicon.ico"

;--------------------------------
; Pages

!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "..\LICENSE"
!insertmacro MUI_PAGE_DIRECTORY
Page custom ConfigurationPage ConfigurationPageLeave
!insertmacro MUI_PAGE_INSTFILES
!insertmacro MUI_PAGE_FINISH

!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

;--------------------------------
; Languages

!insertmacro MUI_LANGUAGE "English"

;--------------------------------
; Custom Configuration Page

Function ConfigurationPage
  !insertmacro MUI_HEADER_TEXT "Configuration" "Configure TAP settings"

  nsDialogs::Create 1018
  Pop $Dialog

  ${If} $Dialog == error
    Abort
  ${EndIf}

  ; Root Password
  ${NSD_CreateLabel} 0 0 100% 12u "Root Administrator Password:"
  Pop $Label

  ${NSD_Creatapassword} 0 14u 100% 12u ""
  Pop $PasswordField
  ${NSD_SetText} $PasswordField $RootPassword

  ${NSD_CreateLabel} 0 32u 100% 24u "This password is required for the root administrator account. Choose a strong password with at least 12 characters."
  Pop $Label

  ; Backend Port
  ${NSD_CreateLabel} 0 64u 100% 12u "Backend Server Port:"
  Pop $Label

  ${NSD_CreateNumber} 0 78u 60u 12u "8000"
  Pop $PortField
  ${NSD_SetText} $PortField $BackendPort

  ${NSD_CreateLabel} 70u 78u 100% 12u "(default: 8000)"
  Pop $Label

  nsDialogs::Show
FunctionEnd

Function ConfigurationPageLeave
  ${NSD_GetText} $PasswordField $RootPassword
  ${NSD_GetText} $PortField $BackendPort

  ; Validate password
  StrLen $0 $RootPassword
  ${If} $0 < 8
    MessageBox MB_OK|MB_ICONEXCLAMATION "Password must be at least 8 characters long."
    Abort
  ${EndIf}

  ; Validate port
  ${If} $BackendPort == ""
    StrCpy $BackendPort "8000"
  ${EndIf}
FunctionEnd

;--------------------------------
; Installer Sections

Section "TAP Application" SecMain
  SectionIn RO  ; Required section

  SetOutPath "$INSTDIR"

  ; Copy backend files
  SetOutPath "$INSTDIR\backend"
  File /r "..\build\TAP-${VERSION}\backend\*.*"

  ; Copy frontend files
  SetOutPath "$INSTDIR\frontend"
  File /r "..\build\TAP-${VERSION}\frontend\*.*"

  ; Copy documentation
  SetOutPath "$INSTDIR\docs"
  File "..\build\TAP-${VERSION}\docs\*.*"

  ; Copy scripts
  SetOutPath "$INSTDIR\scripts"
  File "..\build\TAP-${VERSION}\scripts\*.*"

  ; Create data directory
  CreateDirectory "$INSTDIR\data"

  ; Create logs directory
  CreateDirectory "$INSTDIR\logs"

  ; Create configuration file
  SetOutPath "$INSTDIR\backend"
  FileOpen $0 "$INSTDIR\backend\.env" w
  FileWrite $0 "# TAP Configuration$\r$\n"
  FileWrite $0 "# Generated by installer$\r$\n"
  FileWrite $0 "$\r$\n"
  FileWrite $0 "# Environment Settings$\r$\n"
  FileWrite $0 "ENVIRONMENT=production$\r$\n"
  FileWrite $0 "LOG_LEVEL=INFO$\r$\n"
  FileWrite $0 "$\r$\n"
  FileWrite $0 "# Server Settings$\r$\n"
  FileWrite $0 "BACKEND_PORT=$BackendPort$\r$\n"
  FileWrite $0 "$\r$\n"
  FileWrite $0 "# Authentication$\r$\n"
  FileWrite $0 "ROOT_PASSWORD=$RootPassword$\r$\n"
  FileWrite $0 "$\r$\n"
  FileWrite $0 "# Security - JWT Key Encryption Password$\r$\n"
  FileWrite $0 "# This password encrypts the RSA private key used for JWT tokens$\r$\n"
  FileWrite $0 "JWT_KEY_PASSWORD=$JwtKeyPassword$\r$\n"
  FileWrite $0 "$\r$\n"
  FileWrite $0 "# Database$\r$\n"
  FileWrite $0 "DATABASE_URL=sqlite:///$INSTDIR\data\tap.sqlite$\r$\n"
  FileClose $0

  ; Store installation folder
  WriteRegStr HKLM "Software\MonteVista\TAP" "InstallDir" "$INSTDIR"
  WriteRegStr HKLM "Software\MonteVista\TAP" "Version" "${VERSION}"

  ; Create uninstaller
  WriteUninstaller "$INSTDIR\Uninstall.exe"

  ; Add to Add/Remove Programs
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                   "DisplayName" "TAP - Timeclock and Payroll"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                   "UninstallString" "$\"$INSTDIR\Uninstall.exe$\""
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                   "QuietUninstallString" "$\"$INSTDIR\Uninstall.exe$\" /S"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                   "InstallLocation" "$INSTDIR"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                   "DisplayIcon" "$INSTDIR\backend\tap.exe"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                   "Publisher" "MonteVista Apps"
  WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                   "DisplayVersion" "${VERSION}"
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                     "NoModify" 1
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                     "NoRepair" 1

  ; Get installed size
  ${GetSize} "$INSTDIR" "/S=0K" $0 $1 $2
  IntFmt $0 "0x%08X" $0
  WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP" \
                     "EstimatedSize" "$0"
SectionEnd

Section "Desktop Shortcut" SecDesktop
  CreateShortcut "$DESKTOP\TAP.lnk" "$INSTDIR\backend\tap.exe" "" "$INSTDIR\backend\tap.exe" 0
SectionEnd

Section "Start Menu Shortcuts" SecStartMenu
  CreateDirectory "$SMPROGRAMS\TAP"
  CreateShortcut "$SMPROGRAMS\TAP\TAP Server.lnk" "$INSTDIR\backend\tap.exe" "" "$INSTDIR\backend\tap.exe" 0
  CreateShortcut "$SMPROGRAMS\TAP\TAP Documentation.lnk" "$INSTDIR\docs\README.md"
  CreateShortcut "$SMPROGRAMS\TAP\Uninstall TAP.lnk" "$INSTDIR\Uninstall.exe"

  ; Create URL shortcut to open browser
  FileOpen $0 "$SMPROGRAMS\TAP\Open TAP.url" w
  FileWrite $0 "[InternetShortcut]$\r$\n"
  FileWrite $0 "URL=http://localhost:$BackendPort$\r$\n"
  FileClose $0
SectionEnd

Section "Firewall Rule" SecFirewall
  ; Add firewall rule for the backend port
  nsExec::ExecToLog 'netsh advfirewall firewall add rule name="TAP Backend" dir=in action=allow protocol=TCP localport=$BackendPort'
SectionEnd

Section "Startup Scripts" SecScripts
  ; Create batch files for manual start/stop
  SetOutPath "$INSTDIR"

  FileOpen $0 "$INSTDIR\start-tap.bat" w
  FileWrite $0 "@echo off$\r$\n"
  FileWrite $0 "cd /d $\"$INSTDIR\backend$\"$\r$\n"
  FileWrite $0 "start $\"TAP Server$\" tap.exe$\r$\n"
  FileWrite $0 "echo TAP Server started. Access at http://localhost:$BackendPort$\r$\n"
  FileWrite $0 "echo Press any key to open in browser...$\r$\n"
  FileWrite $0 "pause >nul$\r$\n"
  FileWrite $0 "start http://localhost:$BackendPort$\r$\n"
  FileClose $0

  FileOpen $0 "$INSTDIR\stop-tap.bat" w
  FileWrite $0 "@echo off$\r$\n"
  FileWrite $0 "taskkill /IM tap.exe /F$\r$\n"
  FileWrite $0 "echo TAP Server stopped.$\r$\n"
  FileWrite $0 "pause$\r$\n"
  FileClose $0

  ; Copy service installation script
  SetOutPath "$INSTDIR\scripts"
  File "..\scripts\install-service.ps1"

  ; Create service installation shortcut
  FileOpen $0 "$INSTDIR\install-service.bat" w
  FileWrite $0 "@echo off$\r$\n"
  FileWrite $0 "echo Installing TAP as Windows Service...$\r$\n"
  FileWrite $0 "powershell -ExecutionPolicy Bypass -File $\"$INSTDIR\scripts\install-service.ps1$\" -InstallDir $\"$INSTDIR$\" -Port $BackendPort$\r$\n"
  FileWrite $0 "pause$\r$\n"
  FileClose $0

  FileOpen $0 "$INSTDIR\uninstall-service.bat" w
  FileWrite $0 "@echo off$\r$\n"
  FileWrite $0 "echo Removing TAP Windows Service...$\r$\n"
  FileWrite $0 "powershell -ExecutionPolicy Bypass -File $\"$INSTDIR\scripts\install-service.ps1$\" -InstallDir $\"$INSTDIR$\" -Uninstall$\r$\n"
  FileWrite $0 "pause$\r$\n"
  FileClose $0
SectionEnd

;--------------------------------
; Section Descriptions

!insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
  !insertmacro MUI_DESCRIPTION_TEXT ${SecMain} "Install TAP application files (required)."
  !insertmacro MUI_DESCRIPTION_TEXT ${SecDesktop} "Create a desktop shortcut."
  !insertmacro MUI_DESCRIPTION_TEXT ${SecStartMenu} "Create Start Menu shortcuts."
  !insertmacro MUI_DESCRIPTION_TEXT ${SecFirewall} "Add Windows Firewall rule for TAP."
  !insertmacro MUI_DESCRIPTION_TEXT ${SecScripts} "Create startup scripts and Windows service installer."
!insertmacro MUI_FUNCTION_DESCRIPTION_END

;--------------------------------
; Installer Functions

Function .onInit
  ; Set default values
  StrCpy $RootPassword ""
  StrCpy $BackendPort "8000"
  StrCpy $JwtKeyPassword ""

  ; Generate random JWT key password using PowerShell
  nsExec::ExecToStack 'powershell -NoProfile -Command "[System.Convert]::ToBase64String([System.Security.Cryptography.RandomNumberGenerator]::GetBytes(32))"'
  Pop $0  ; Exit code
  Pop $JwtKeyPassword  ; Output

  ; Trim whitespace from the password
  ${If} $JwtKeyPassword == ""
    ; Fallback if PowerShell fails - use a combination of timestamp and random
    StrCpy $JwtKeyPassword "TAP_JWT_KEY_$HWNDPARENT$0"
  ${EndIf}

  ; Check for previous installation
  ReadRegStr $0 HKLM "Software\MonteVista\TAP" "InstallDir"
  ${If} $0 != ""
    StrCpy $INSTDIR $0
  ${EndIf}
FunctionEnd

;--------------------------------
; Uninstaller Section

Section "Uninstall"
  ; Stop and remove Windows service if installed
  nsExec::ExecToLog 'net stop TAPService'
  nsExec::ExecToLog 'sc delete TAPService'

  ; Stop TAP if running as standalone
  nsExec::ExecToLog 'taskkill /IM tap.exe /F'

  ; Remove firewall rule
  nsExec::ExecToLog 'netsh advfirewall firewall delete rule name="TAP Backend"'

  ; Remove files
  RMDir /r "$INSTDIR\backend"
  RMDir /r "$INSTDIR\frontend"
  RMDir /r "$INSTDIR\docs"
  RMDir /r "$INSTDIR\scripts"
  RMDir /r "$INSTDIR\logs"
  RMDir /r "$INSTDIR\nssm"
  Delete "$INSTDIR\start-tap.bat"
  Delete "$INSTDIR\stop-tap.bat"
  Delete "$INSTDIR\install-service.bat"
  Delete "$INSTDIR\uninstall-service.bat"
  Delete "$INSTDIR\Uninstall.exe"

  ; Ask about data directory
  MessageBox MB_YESNO|MB_ICONQUESTION "Do you want to keep the database and configuration files?$\r$\n$\r$\nClick Yes to keep your data, or No to remove everything." IDYES KeepData
    RMDir /r "$INSTDIR\data"
    Delete "$INSTDIR\backend\.env"
  KeepData:

  ; Remove installation directory (if empty)
  RMDir "$INSTDIR"

  ; Remove shortcuts
  Delete "$DESKTOP\TAP.lnk"
  RMDir /r "$SMPROGRAMS\TAP"

  ; Remove registry keys
  DeleteRegKey HKLM "Software\MonteVista\TAP"
  DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\TAP"
SectionEnd

;--------------------------------
; Uninstaller Functions

Function un.onInit
FunctionEnd
